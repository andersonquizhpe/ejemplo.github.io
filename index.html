<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.


2222222222222222222222222222
222222222222222
222222222222

source /tmp/wsdldb.sql
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

        <!--bootstrap-->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" >
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
        <script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.10.0/jquery.validate.min.js"></script>
        <script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.10.0/localization/messages_es.js"></script>

        <script>
            $(document).ready(function () {
                validar();
                cargarDepartament();
                cargarProvincia();
                cargarCANTON('AZUAY');
                $("#provincia").change(function () {
                    cargarCANTON($("#provincia").val());
                });
                $("#FechaF").change(function () {
                    var meses = calcularEdad($("#FechaI").val(), $("#FechaF").val());
                    $("#tiempo").val(meses);
                });

                $("#extra").change(function () {
                    verExtra();
                });
                listar();
                $("#tipo").change(function (){
                    cargarNombre($("#tipo").val());
                });
            });

            function calcularEdad(fecha1, fecha2) {

                var inicio = new Date(fecha1);
                var fin = new Date(fecha2);

                if (fin >= inicio) {
                    var años = fin.getFullYear() - inicio.getFullYear();
                    var m = fin.getMonth() - inicio.getMonth() + (años * 12);

                    return m;
                } else {
                    alert("Verifique bien los datos");
                }
                return 0;
            }

            function validar() {
                $("#formulario").validate({
                    rules: {
                        nombre: {
                            required: true,
                            minlength: 3
                        },
                        fechai: {
                            required: true
                        },
                        fechaf: {
                            required: true
                        },
                        time: {
                            required: true
                        },
                        pais: {
                            required: true
                        },
                        describe: {
                            required: true
                        },
                        monto: {
                            required: true
                        },
                        tipo: {
                            required: true
                        }
                    },

                    submitHandler: function () {
                        // do other things for a valid form
                        //form.submit();
                        //console.log("dato enviado");
                        if ( $("#external").val()=== "0") {
                            console.log("estas guardando");
                            //guardar();
                        }else{
                            //modificar();
                            console.log($("#external").val());
                        }
                    }
                });
            }

            function guardar() {
                var url = "http://localhost/examen_cuarto_b/wsdl2.php?wsdl";
                var mensaje = '';
                mensaje += '<Envelope xmlns="http://schemas.xmlsoap.org/soap/envelope/"y>';
                mensaje += '<Body>';
                mensaje += '<guardar_proyecto xmlns="urn:server">';
                mensaje += '<token>' + "EXAMEN_4_B" + '</token>';
                mensaje += '<nombre>' + $("#nombre").val() + '</nombre>';
                mensaje += '<finicio>' + $("#FechaI").val() + '</finicio>';
                mensaje += '<ffinalizacion>' + $("#FechaF").val() + '</ffinalizacion>';
                mensaje += '<tiempo>' + $("#tiempo").val() + '</tiempo>';
                mensaje += '<provincia>' + $("#provincia").val() + '</provincia>';
                mensaje += '<canton>' + $("#canton").val() + '</canton>';
                mensaje += '<pais>' + $("#pais").val() + '</pais>';
                mensaje += '<extranjero>' + $("#extra").val() + '</extranjero>';
                mensaje += '<descripcion>' + $("#descripcion").val() + '</descripcion>';
                mensaje += '<monto>' + $("#monto").val() + '</monto>';
                mensaje += '<id>' + $("#tipo").val() + '</id>';
                mensaje += '</guardar_proyecto>';
                mensaje += '</Body>';
                mensaje += '</Envelope>';
                $.ajax({
                    url: url,
                    type: 'POST',
                    contentType: 'text/xml',
                    data: mensaje,
                    dataType: 'xml',
                    success: function (data, textStatus, jqXHR) {
                        //console.log(mensaje);
                        if (jqXHR.status == '200') {
                            alert("Se ha registrado");
                            //location.href="index.html";
                            listar();
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log(mensaje);
                        console.log(jqXHR.responseText);
                    }
                });

            }
            
            function modificar() {
                var url = "http://localhost/examen_cuarto_b/wsdl2.php?wsdl";
                var mensaje = '';
                mensaje += '<Envelope xmlns="http://schemas.xmlsoap.org/soap/envelope/"y>';
                mensaje += '<Body>';
                mensaje += '<modificar_proyecto xmlns="urn:server">';
                mensaje += '<token>' + "EXAMEN_4_B" + '</token>';
                mensaje += '<external>' + $("#external").val() + '</external>';
                mensaje += '<nombre>' + $("#nombre").val() + '</nombre>';
                mensaje += '<finicio>' + $("#FechaI").val() + '</finicio>';
                mensaje += '<ffinalizacion>' + $("#FechaF").val() + '</ffinalizacion>';
                mensaje += '<tiempo>' + $("#tiempo").val() + '</tiempo>';
                mensaje += '<provincia>' + $("#provincia").val() + '</provincia>';
                mensaje += '<canton>' + $("#canton").val() + '</canton>';
                mensaje += '<pais>' + $("#pais").val() + '</pais>';
                mensaje += '<extranjero>' + $("#extra").val() + '</extranjero>';
                mensaje += '<descripcion>' + $("#descripcion").val() + '</descripcion>';
                mensaje += '<monto>' + $("#monto").val() + '</monto>';
                mensaje += '<id_departamento>' + $("#tipo").val() + '</id_departamento>';
                mensaje += '</modificar_proyecto>';
                mensaje += '</Body>';
                mensaje += '</Envelope>';
                $.ajax({
                    url: url,
                    type: 'POST',
                    contentType: 'text/xml',
                    data: mensaje,
                    dataType: 'xml',
                    success: function (data, textStatus, jqXHR) {
                        //console.log(mensaje);
                        if (jqXHR.status == '200') {
                            alert("Se ha modificado");
                            //location.href="index.html";
                            listar();
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log(mensaje);
                        console.log(jqXHR.responseText);
                    }
                });

            }

            function cargarDepartament() {
                var urlj = "http://localhost/examen_cuarto_b/json2.php";
                var accion = "/listar_departamentos";
                $.ajax({
                    url: urlj + accion,
                    type: 'GET',
                    dataType: 'json',
                    headers: {'api-token': "EXAMEN_4_B"},
                    success: function (data, textStatus, jqXHR) {
                        //console.log(data);
                        var opciones = "";

                        $.each(data, function (i, item) {
                            opciones += '<option value="' + item.id + '">' + item.nombre + '</option>';
                        });
                        $("#tipo").html(opciones);
                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR);
                    }
                });

            }
            //explicar lo que se tenia
            function cargarProvincia() {
                var urlj = "http://localhost/examen_cuarto_b/json2.php";
                var accion = "/listar_provincias";
                $.ajax({
                    url: urlj + accion,
                    type: 'GET',
                    dataType: 'json',
                    success: function (data, textStatus, jqXHR) {
                        //console.log(data);

                        var opciones = "";
                        // opciones+='<option value="S/N">S/N</option>';
                        $.each(data, function (i, item) {
                            //var es = item.nombre.replace(/\s/,"_");
                            opciones += '<option value="' + item.nombre.replace(/ /g, "_") + '">' + item.nombre + '</option>';
                        });

                        $("#provincia").html(opciones);
                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR);
                    }
                });

            }

            function cargarCANTON(provinciaD) {
                var urlj = "http://localhost/examen_cuarto_b/json2.php";
                //var provincia = $("#provincia").val();
                var accion = "/listar_cantones/" + provinciaD;
                $.ajax({
                    url: urlj + accion,
                    type: 'GET',
                    dataType: 'json',
                    success: function (data, textStatus, jqXHR) {
                        //console.log(data);
                        var opciones = "";

                        $.each(data, function (i, item) {
                            opciones += '<option value="' + item.canton + '">' + item.canton + '</option>';
                        });
                        $("#canton").html(opciones);
                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR);
                    }
                });

            }

            function verExtra() {
                var a = $("#extra").val();
                
                if (a === '1') {
                    $("#provincia").hide();
                    $("#canton").hide();
                    $("#pais").val("");
                    var option = '<option value="S/N">S/N</option>';
                    $("#canton").html(option);
                    $("#provincia").html(option);




                    var tr = $("#monto").val() * 1;
                    var total = tr + (tr * 0.20 * 1);
                    $("#monto").val(total);
                } else {
                    $("#provincia").show();
                    $("#canton").show();
                    $("#pais").val("ECUADOR");
                    cargarCANTON('AZUAY');
                    cargarProvincia();
                }
            }

            function  cargarDatos(data) {
                var datos = JSON.parse('{"' + data.replace(/&/g, '","').replace(/=/g, '":"') + '"}', function (key, value) {
                    return key === "" ? value : decodeURIComponent(value);
                });
                console.log(datos);


                $("#tipo").val(datos.id_departamento);
                $("#nombre").val(datos.nombre);
                $("#FechaI").val(datos.f_inicio);
                $("#FechaF").val(datos.f_finalizacion);
                $("#provincia").val(datos.provincia);
                $("#canton").val(datos.canton);
                $("#extra").val(datos.extranjero);
                $("#pais").val(datos.pais);
                $("#monto").val(datos.monto);
                $("#external").val(datos.external);
                $("#descripcion").val(datos.descripcion);
                var tiempo = calcularEdad($("#FechaI").val(), $("#FechaF").val());
                $("#tiempo").val(tiempo);


            }

            function listar() {
                var urlr = "http://localhost/examen_cuarto_b/json2.php";
                var accion = "/listar_proyectos";
                $.ajax({
                    url: urlr + accion,
                    type: 'GET',
                    dataType: 'json',
                    headers: {'api-token': "EXAMEN_4_B"},
                    success: function (data, textStatus, jqXHR) {

                        if (data.codigo) {
                            manejoErroresJson(data.message, data.codigo);
                        } else {
                            var tabla = '';
                            $.each(data, function (index, item) {
                                var itemData = $.param(item);
                                //console.log(itemData);
                                tabla += '<tr>';
                                tabla += '<td>' + (index + 1) + '</td>';
                                tabla += '<td>' + item.nombre + '</td>';
                                tabla += '<td>' + item.f_inicio + '</td>';
                                tabla += '<td>' + item.f_finalizacion + '</td>';
                                tabla += '<td>' + item.provincia + '</td>';
                                tabla += '<td>' + item.canton + '</td>';
                                tabla += '<td>' + item.pais + '</td>';
                                tabla += '<td>' + item.descripcion + '</td>';
                                tabla += '<td>' + item.monto + '</td>';
                                tabla += '<td>' + item.id_departamento + '</td>';
                                tabla += '<td><a id="' + item + '" href="#"  class="btn btn-primary" onclick="cargarDatos(' + "'" + itemData + "'" + ')">Modificar</a></td>';
                                tabla += '</tr>';
                            });
                            $("#tabla tbody").html(tabla);
                        }

                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR);
                    }
                });
            }
            
            function cargarNombre(idn){
               var urlj = "http://localhost/examen_cuarto_b/json2.php/obtener_departamento/";
                var accion = idn;
                $.ajax({
                    url: urlj + accion,
                    type: 'GET',
                    dataType: 'json',
                    headers: {'api-token': "EXAMEN_4_B"},
                    success: function (data, textStatus, jqXHR) {
                        console.log(data);
                        
                        var option='';
                        $.each(data, function (i, item) {
                            console.log(item.nombre);
                        });
                        //console.log(option);

                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR);
                    }
                }); 
            }

        </script>
    </head>
    <body>

        <div class="global-container">
            <div class="card login-form">
                <div class="card-body">
                    <h3 class="card-title text-center">Registra tu proyecto</h3>
                    <div class="card-text">

                        <form id="formulario" method="POST">
                            <!-- to error: add class "has-danger" -->

                            <div id="error"></div>
                            <div>
                                <input type="hidden" id="external" value="0">
                            </div>
                            <div>
                                <label for="tipo">Tipo de proyecto</label>
                                <select id="tipo">

                                </select>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control form-control-sm" id="nombre"  name="nombre" placeholder="Nombre Proyecto">
                            </div>
                            <div class="form-group">
                                <label for="FechaI">Fecha Inicio</label>
                                <input type="date" class="form-control form-control-sm" id="FechaI"  name="fechai" >
                            </div>
                            <div class="form-group">
                                <label for="FechaF">Fecha Final</label>
                                <input type="date" class="form-control form-control-sm" id="FechaF"  name="fechaf">
                            </div>
                            <div class="form-group">
                                <label for="tiempo">Tiempo Determinado</label>
                                <input type="number" class="form-control form-control-sm" id="tiempo"  name="time" readonly>
                            </div>
                            <div class="form-group">
                                <select id="provincia">

                                </select>
                            </div>
                            <div class="form-group">
                                <select id="canton">

                                </select>
                            </div>
                            <div class="form-group">
                                <label>Extranjero</label>
                                <select id="extra">
                                    <option value="0">No</option>
                                    <option value="1">Si</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="text" placeholder="Pais" id="pais" >
                            </div>
                            <div class="form-group">
                                <textarea id="descripcion" placeholder="Descripcion" name="describe"></textarea>
                            </div>
                            <div class="form-group">
                                <input type="number" placeholder="Monto 0.00" id="monto" name="monto">
                            </div>
                            <div>
                                <input type="submit" >
                            </div>
                        </form>

                        <table class="table" id="tabla">
                            <thead class="thead-dark">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Nombre Proyecto</th>
                                    <th scope="col">Fecha Inicio</th>
                                    <th scope="col">Fecha Finalizacion</th>
                                    <th scope="col">Provincia</th>
                                    <th scope="col">Canton</th>
                                    <th scope="col">Pais</th>
                                    <th scope="col">Descripcion</th>
                                    <th scope="col">Monto</th>
                                    <th scope="col">Departamento</th>
                                    <th scope="col">Accion</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
